{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.handleStreamPartialPayment = exports.handlePartialPayment = void 0;\nconst bignumber_js_1 = __importDefault(require(\"bignumber.js\"));\nconst ripple_binary_codec_1 = require(\"ripple-binary-codec\");\nconst transactions_1 = require(\"../models/transactions\");\nconst utils_1 = require(\"../models/utils\");\nconst WARN_PARTIAL_PAYMENT_CODE = 2001;\nfunction amountsEqual(amt1, amt2) {\n  if (typeof amt1 === 'string' && typeof amt2 === 'string') {\n    return amt1 === amt2;\n  }\n  if (typeof amt1 === 'string' || typeof amt2 === 'string') {\n    return false;\n  }\n  if ((0, transactions_1.isMPTAmount)(amt1) && (0, transactions_1.isMPTAmount)(amt2)) {\n    const aValue = new bignumber_js_1.default(amt1.value);\n    const bValue = new bignumber_js_1.default(amt2.value);\n    return amt1.mpt_issuance_id === amt2.mpt_issuance_id && aValue.isEqualTo(bValue);\n  }\n  if ((0, transactions_1.isMPTAmount)(amt1) || (0, transactions_1.isMPTAmount)(amt2)) {\n    return false;\n  }\n  const aValue = new bignumber_js_1.default(amt1.value);\n  const bValue = new bignumber_js_1.default(amt2.value);\n  return amt1.currency === amt2.currency && amt1.issuer === amt2.issuer && aValue.isEqualTo(bValue);\n}\nfunction isPartialPayment(tx, metadata) {\n  var _a, _b;\n  if (tx == null || metadata == null || tx.TransactionType !== 'Payment') {\n    return false;\n  }\n  let meta = metadata;\n  if (typeof meta === 'string') {\n    if (meta === 'unavailable') {\n      return false;\n    }\n    meta = (0, ripple_binary_codec_1.decode)(meta);\n  }\n  const tfPartial = typeof tx.Flags === 'number' ? (0, utils_1.isFlagEnabled)(tx.Flags, transactions_1.PaymentFlags.tfPartialPayment) : (_a = tx.Flags) === null || _a === void 0 ? void 0 : _a.tfPartialPayment;\n  if (!tfPartial) {\n    return false;\n  }\n  const delivered = meta.delivered_amount;\n  const amount = (_b = tx.DeliverMax) !== null && _b !== void 0 ? _b : tx.Amount;\n  if (delivered === undefined) {\n    return false;\n  }\n  return !amountsEqual(delivered, amount);\n}\nfunction txHasPartialPayment(response) {\n  return isPartialPayment(response.result.tx_json, response.result.meta);\n}\nfunction txEntryHasPartialPayment(response) {\n  return isPartialPayment(response.result.tx_json, response.result.metadata);\n}\nfunction accountTxHasPartialPayment(response) {\n  const {\n    transactions\n  } = response.result;\n  const foo = transactions.some(tx => {\n    if (tx.tx_json != null) {\n      const transaction = tx;\n      return isPartialPayment(transaction.tx_json, transaction.meta);\n    }\n    const transaction = tx;\n    return isPartialPayment(transaction.tx, transaction.meta);\n  });\n  return foo;\n}\nfunction hasPartialPayment(command, response) {\n  switch (command) {\n    case 'tx':\n      return txHasPartialPayment(response);\n    case 'transaction_entry':\n      return txEntryHasPartialPayment(response);\n    case 'account_tx':\n      return accountTxHasPartialPayment(response);\n    default:\n      return false;\n  }\n}\nfunction handlePartialPayment(command, response) {\n  var _a;\n  if (hasPartialPayment(command, response)) {\n    const warnings = (_a = response.warnings) !== null && _a !== void 0 ? _a : [];\n    const warning = {\n      id: WARN_PARTIAL_PAYMENT_CODE,\n      message: 'This response contains a Partial Payment'\n    };\n    warnings.push(warning);\n    response.warnings = warnings;\n  }\n}\nexports.handlePartialPayment = handlePartialPayment;\nfunction handleStreamPartialPayment(stream, log) {\n  var _a, _b;\n  if (isPartialPayment((_a = stream.tx_json) !== null && _a !== void 0 ? _a : stream.transaction, stream.meta)) {\n    const warnings = (_b = stream.warnings) !== null && _b !== void 0 ? _b : [];\n    const warning = {\n      id: WARN_PARTIAL_PAYMENT_CODE,\n      message: 'This response contains a Partial Payment'\n    };\n    warnings.push(warning);\n    stream.warnings = warnings;\n    log('Partial payment received', JSON.stringify(stream));\n  }\n}\nexports.handleStreamPartialPayment = handleStreamPartialPayment;","map":{"version":3,"names":["bignumber_js_1","__importDefault","require","ripple_binary_codec_1","transactions_1","utils_1","WARN_PARTIAL_PAYMENT_CODE","amountsEqual","amt1","amt2","isMPTAmount","aValue","default","value","bValue","mpt_issuance_id","isEqualTo","currency","issuer","isPartialPayment","tx","metadata","TransactionType","meta","decode","tfPartial","Flags","isFlagEnabled","PaymentFlags","tfPartialPayment","_a","delivered","delivered_amount","amount","_b","DeliverMax","Amount","undefined","txHasPartialPayment","response","result","tx_json","txEntryHasPartialPayment","accountTxHasPartialPayment","transactions","foo","some","transaction","hasPartialPayment","command","handlePartialPayment","warnings","warning","id","message","push","exports","handleStreamPartialPayment","stream","log","JSON","stringify"],"sources":["/Users/caiyongsheng/Developer/nus_fintech_project/nus_fintech_gang_plus_side_characters/frontend/node_modules/xrpl/src/client/partialPayment.ts"],"sourcesContent":["import BigNumber from 'bignumber.js'\nimport { decode } from 'ripple-binary-codec'\n\nimport type {\n  TransactionEntryResponse,\n  TransactionStream,\n  TransactionV1Stream,\n  TxResponse,\n} from '..'\nimport type {\n  Amount,\n  IssuedCurrency,\n  APIVersion,\n  DEFAULT_API_VERSION,\n  MPTAmount,\n} from '../models/common'\nimport type {\n  AccountTxTransaction,\n  RequestResponseMap,\n} from '../models/methods'\nimport { AccountTxVersionResponseMap } from '../models/methods/accountTx'\nimport { BaseRequest, BaseResponse } from '../models/methods/baseMethod'\nimport { PaymentFlags, Transaction, isMPTAmount } from '../models/transactions'\nimport type { TransactionMetadata } from '../models/transactions/metadata'\nimport { isFlagEnabled } from '../models/utils'\n\nconst WARN_PARTIAL_PAYMENT_CODE = 2001\n\n/* eslint-disable complexity -- check different token types */\n/* eslint-disable @typescript-eslint/consistent-type-assertions -- known currency type */\nfunction amountsEqual(\n  amt1: Amount | MPTAmount,\n  amt2: Amount | MPTAmount,\n): boolean {\n  // Compare XRP\n  if (typeof amt1 === 'string' && typeof amt2 === 'string') {\n    return amt1 === amt2\n  }\n\n  if (typeof amt1 === 'string' || typeof amt2 === 'string') {\n    return false\n  }\n\n  // Compare MPTs\n  if (isMPTAmount(amt1) && isMPTAmount(amt2)) {\n    const aValue = new BigNumber(amt1.value)\n    const bValue = new BigNumber(amt2.value)\n\n    return (\n      amt1.mpt_issuance_id === amt2.mpt_issuance_id && aValue.isEqualTo(bValue)\n    )\n  }\n\n  if (isMPTAmount(amt1) || isMPTAmount(amt2)) {\n    return false\n  }\n\n  // Compare issued currency (IOU)\n  const aValue = new BigNumber(amt1.value)\n  const bValue = new BigNumber(amt2.value)\n\n  return (\n    (amt1 as IssuedCurrency).currency === (amt2 as IssuedCurrency).currency &&\n    (amt1 as IssuedCurrency).issuer === (amt2 as IssuedCurrency).issuer &&\n    aValue.isEqualTo(bValue)\n  )\n}\n/* eslint-enable complexity */\n/* eslint-enable @typescript-eslint/consistent-type-assertions */\n\n/* eslint-disable complexity -- required here for multiple checks */\nfunction isPartialPayment(\n  tx?: Transaction,\n  metadata?: TransactionMetadata | string,\n): boolean {\n  if (tx == null || metadata == null || tx.TransactionType !== 'Payment') {\n    return false\n  }\n\n  let meta = metadata\n  if (typeof meta === 'string') {\n    if (meta === 'unavailable') {\n      return false\n    }\n\n    /* eslint-disable-next-line @typescript-eslint/consistent-type-assertions -- binary-codec typing */\n    meta = decode(meta) as unknown as TransactionMetadata\n  }\n\n  const tfPartial =\n    typeof tx.Flags === 'number'\n      ? isFlagEnabled(tx.Flags, PaymentFlags.tfPartialPayment)\n      : tx.Flags?.tfPartialPayment\n\n  if (!tfPartial) {\n    return false\n  }\n\n  const delivered = meta.delivered_amount\n\n  const amount = tx.DeliverMax ?? tx.Amount\n\n  if (delivered === undefined) {\n    return false\n  }\n\n  return !amountsEqual(delivered, amount)\n}\n/* eslint-enable complexity */\n\nfunction txHasPartialPayment(response: TxResponse): boolean {\n  return isPartialPayment(response.result.tx_json, response.result.meta)\n}\n\nfunction txEntryHasPartialPayment(response: TransactionEntryResponse): boolean {\n  return isPartialPayment(response.result.tx_json, response.result.metadata)\n}\n\nfunction accountTxHasPartialPayment<\n  Version extends APIVersion = typeof DEFAULT_API_VERSION,\n>(response: AccountTxVersionResponseMap<Version>): boolean {\n  const { transactions } = response.result\n  const foo = transactions.some((tx) => {\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access -- required to check API version model\n    if (tx.tx_json != null) {\n      // eslint-disable-next-line @typescript-eslint/consistent-type-assertions -- use API v2 model\n      const transaction = tx as AccountTxTransaction\n      return isPartialPayment(transaction.tx_json, transaction.meta)\n    }\n    // eslint-disable-next-line @typescript-eslint/consistent-type-assertions -- use API v1 model\n    const transaction = tx as AccountTxTransaction<1>\n    return isPartialPayment(transaction.tx, transaction.meta)\n  })\n  return foo\n}\n\nfunction hasPartialPayment<\n  R extends BaseRequest,\n  V extends APIVersion = typeof DEFAULT_API_VERSION,\n  T = RequestResponseMap<R, V>,\n>(command: string, response: T): boolean {\n  /* eslint-disable @typescript-eslint/consistent-type-assertions -- Request type is known at runtime from command */\n  switch (command) {\n    case 'tx':\n      return txHasPartialPayment(response as TxResponse)\n    case 'transaction_entry':\n      return txEntryHasPartialPayment(response as TransactionEntryResponse)\n    case 'account_tx':\n      return accountTxHasPartialPayment(\n        response as AccountTxVersionResponseMap<V>,\n      )\n    default:\n      return false\n  }\n  /* eslint-enable @typescript-eslint/consistent-type-assertions */\n}\n\n/**\n * Checks a response for a partial payment.\n *\n * @param command - Command from the request, tells us what response to expect.\n * @param response - Response to check for a partial payment.\n */\nexport function handlePartialPayment<\n  R extends BaseRequest,\n  T = RequestResponseMap<R, APIVersion>,\n>(command: string, response: T): void {\n  if (hasPartialPayment(command, response)) {\n    // eslint-disable-next-line @typescript-eslint/consistent-type-assertions -- We are checking dynamically and safely.\n    const warnings = (response as BaseResponse).warnings ?? []\n\n    const warning = {\n      id: WARN_PARTIAL_PAYMENT_CODE,\n      message: 'This response contains a Partial Payment',\n    }\n\n    warnings.push(warning)\n\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment -- We are checking dynamically and safely.\n    // @ts-expect-error -- We are checking dynamically and safely.\n    response.warnings = warnings\n  }\n}\n\n/**\n * Check a transaction from a subscription stream for partial payment.\n *\n * @param stream - Stream Transaction to check for partial payment.\n * @param log - The method used for logging by the connection (to report the partial payment).\n */\nexport function handleStreamPartialPayment(\n  stream: TransactionStream | TransactionV1Stream,\n  log: (id: string, message: string) => void,\n): void {\n  if (isPartialPayment(stream.tx_json ?? stream.transaction, stream.meta)) {\n    const warnings = stream.warnings ?? []\n\n    const warning = {\n      id: WARN_PARTIAL_PAYMENT_CODE,\n      message: 'This response contains a Partial Payment',\n    }\n\n    warnings.push(warning)\n\n    /* eslint-disable-next-line no-param-reassign -- Handles the case where there are no warnings */\n    stream.warnings = warnings\n\n    log('Partial payment received', JSON.stringify(stream))\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}